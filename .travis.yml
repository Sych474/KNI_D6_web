sudo: true

jobs:
  include:
    #- stage: test build 
    #  language: csharp
    #  mono: none
    #  dotnet: 2.2
    #  script:  
    #  - dotnet build ./ -c Release
    - stage: build and deploy
      dist: trusty
      script:
      - docker login -u=$DOCKER_USERNAME -p=$DOCKER_PASSWORD 
      - sed -i 's/\"AdministrationPassword\": \"qwerty\",/\"AdministrationPassword\": \"$EMAIL_PASSWORD\",/g' ./KNI_D6_web/appsettings.json
      - docker build -t sych474/$SERVICE_NAME:latest ./
      - docker push sych474/$SERVICE_NAME:latest
      - sudo apt-get install sshpass
      - sshpass -p $DEPLOY_HOST_USER_PASSWORD scp -o StrictHostKeyChecking=no docker-compose.yml $DEPLOY_HOST_USER@$DEPLOY_HOST_ADDRESS:~/kni_d6;
      - sshpass -p "$DEPLOY_HOST_USER_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_HOST_USER@$DEPLOY_HOST_ADDRESS bash -s < scripts/deploy_to_prod.sh